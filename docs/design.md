# QPS Counter 设计文档

## 系统概述

QPS Counter 是一个高性能的QPS（每秒查询数）计数和限流服务，设计用于大规模分布式系统中监控和控制请求流量。系统采用模块化设计，支持多种计数策略和自适应分片，具有高可靠性和可扩展性。

## 架构设计

### 整体架构

系统由以下核心组件构成：

1. **计数器模块**：负责请求计数和QPS统计
2. **限流器模块**：基于令牌桶算法实现请求限流
3. **API服务**：提供HTTP接口供外部系统调用
4. **监控模块**：收集系统指标并暴露Prometheus格式监控数据
5. **配置管理**：处理系统配置加载和动态更新
6. **日志模块**：提供结构化日志记录

### 组件关系图

```
+----------------+      +----------------+
|                |      |                |
|  API服务       +----->+  计数器模块     |
|                |      |                |
+-------+--------+      +----------------+
        |
        |              +----------------+
        |              |                |
        +------------->+  限流器模块     |
        |              |                |
        |              +----------------+
        |
        |              +----------------+
        |              |                |
        +------------->+  监控模块      |
                       |                |
                       +----------------+
```

## 核心组件设计

### 计数器模块

计数器模块支持两种实现策略：

1. **分片窗口计数器 (Sharded)**：
   - 将时间窗口分为多个槽位(slot)
   - 使用分片技术减少锁竞争
   - 支持自适应分片数量调整

2. **无锁计数器 (LockFree)**：
   - 使用原子操作实现无锁计数
   - 适用于极高并发场景
   - 内存占用更小

#### 自适应分片管理

自适应分片管理器根据系统负载动态调整分片数量：

- 监控当前QPS和内存使用情况
- 当QPS增长超过阈值时增加分片数
- 当QPS下降或内存使用过高时减少分片数
- 分片数量在配置的最小值和最大值之间调整

### 限流器模块

限流器基于令牌桶算法实现：

- 支持配置每秒允许的请求数(rate)和突发容量(burst)
- 支持动态调整限流速率
- 支持启用/禁用限流功能
- 记录被拒绝的请求数量和拒绝率

### 优雅关闭

增强的优雅关闭管理器提供以下功能：

- 在关闭过程中拒绝新请求
- 等待现有请求处理完成
- 支持超时控制和强制关闭
- 提供关闭状态监控

### 监控模块

监控模块收集以下系统指标：

- 当前QPS
- 内存使用量
- CPU使用率
- Goroutine数量
- 请求总数
- 请求处理时间分布

这些指标以Prometheus格式暴露，可通过`/metrics`端点访问。

## 性能优化

系统采用以下性能优化策略：

1. **分片减少锁竞争**：使用分片技术减少高并发下的锁竞争
2. **自适应资源管理**：根据负载动态调整资源使用
3. **无锁算法**：关键路径使用原子操作代替互斥锁
4. **内存优化**：优化数据结构减少内存占用和GC压力

## 配置管理

系统支持以下配置方式：

1. **配置文件**：YAML格式配置文件
2. **环境变量**：使用环境变量覆盖配置文件中的设置
3. **动态配置**：支持运行时调整部分配置（如限流速率）

## 部署方案

系统支持以下部署方式：

1. **独立服务**：作为独立服务部署
2. **Docker容器**：提供Docker镜像和docker-compose配置
3. **Kubernetes**：提供Kubernetes部署配置

## 扩展性设计

系统通过以下方式支持扩展：

1. **接口抽象**：核心组件通过接口定义，支持替换实现
2. **模块化设计**：各模块之间低耦合，易于扩展
3. **配置驱动**：通过配置选择不同实现策略

## 未来规划

1. **分布式计数**：支持多实例协同计数
2. **更多限流策略**：增加漏桶、自适应限流等策略
3. **更丰富的监控指标**：增加更多系统和业务指标
4. **Web管理界面**：提供可视化配置和监控界面