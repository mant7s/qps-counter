# QPS Counter

[![Go Report Card](https://goreportcard.com/badge/github.com/mant7s/qps-counter)](https://goreportcard.com/report/github.com/mant7s/qps-counter)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Go Version](https://img.shields.io/github/go-mod/go-version/mant7s/qps-counter)](https://github.com/mant7s/qps-counter)

é«˜ç²¾åº¦QPSç»Ÿè®¡ç³»ç»Ÿï¼Œé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯çš„å®æ—¶è¯·æ±‚é¢‘ç‡ç»Ÿè®¡ã€‚åŸºäºGoè¯­è¨€å®ç°çš„é«˜æ€§èƒ½è®¡æ•°å™¨ï¼Œæ”¯æŒç™¾ä¸‡çº§QPSåœºæ™¯ä¸‹çš„ç²¾ç¡®ç»Ÿè®¡ã€‚

*[ä¸­æ–‡](README.md) | [English](README.en.md)*

## âœ¨ æ ¸å¿ƒç‰¹æ€§
- ğŸš€ åŒå¼•æ“æ¶æ„ï¼ˆLock-Free/Shardedï¼‰ï¼Œæ”¯æŒç™¾ä¸‡çº§QPSå®æ—¶ç»Ÿè®¡
- ğŸ”„ æ™ºèƒ½åˆ†ç‰‡ç­–ç•¥ï¼ˆåŸºäºCPUæ ¸å¿ƒæ•°çš„åŠ¨æ€åˆ†ç‰‡ï¼Œ10ç§’é—´éš”QPSç›‘æ§ï¼‰
- âš¡ æ—¶é—´çª—å£æ»‘åŠ¨ç®—æ³•ï¼ˆ1sçª—å£ï¼Œ100msç²¾åº¦ï¼‰
- ğŸ§  è‡ªé€‚åº”è´Ÿè½½å‡è¡¡ï¼ˆQPSå˜åŒ–ç‡è¶…30%è‡ªåŠ¨è°ƒæ•´ï¼‰
- ğŸ›¡ï¸ ä¼˜é›…å…³é—­æœºåˆ¶ï¼ˆè¯·æ±‚å®Œæ•´æ€§ä¿éšœï¼‰
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹æ”¯æŒï¼ˆ/healthzï¼‰
- ğŸ“ˆ èµ„æºä½¿ç”¨ç›‘æ§æŒ‡æ ‡
- âš™ï¸ é«˜æ€§èƒ½è®¾è®¡ï¼ˆåŸå­æ“ä½œã€ç»†ç²’åº¦é”ï¼‰

## ğŸ— æ¶æ„è®¾è®¡
```
+-------------------+     +-----------------------+
|   HTTP Endpoint   | â‡’  |  Adaptive Sharding    |
+-------------------+     +-----------------------+
      â†“                               â†“
+---------------+        +------------------------+
| Lock-Freeå¼•æ“ |        | Shardedè®¡æ•°å™¨é›†ç¾¤       |
| (CASåŸå­æ“ä½œ)  |        | (åŠ¨æ€åˆ†ç‰‡)              |
+---------------+        +------------------------+
                                â‡“
+------------------------------------------------+
|           åŠ¨æ€åˆ†ç‰‡ç®¡ç†å™¨                       |
|  â€¢ 10ç§’é—´éš”ç›‘æ§QPSå˜åŒ–ç‡ï¼ˆÂ±30%è§¦å‘è°ƒæ•´ï¼‰        |
|  â€¢ åˆ†ç‰‡æ•°è‡ªåŠ¨ä¼¸ç¼©ï¼ˆæœ€å°CPUæ ¸å¿ƒæ•°ï¼Œæœ€å¤§CPUæ ¸å¿ƒæ•°*8ï¼‰|
+------------------------------------------------+
```

## ğŸ” æŠ€æœ¯å®ç°

### Lock-Freeå¼•æ“
åŸºäºåŸå­æ“ä½œï¼ˆCASï¼‰å®ç°çš„æ— é”è®¡æ•°å™¨ï¼Œé€‚ç”¨äºä¸­ç­‰æµé‡åœºæ™¯ï¼š
- ä½¿ç”¨`atomic.Int64`å®ç°æ— é”è®¡æ•°ï¼Œé¿å…é«˜å¹¶å‘ä¸‹çš„é”ç«äº‰
- æ—¶é—´çª—å£æ»‘åŠ¨ç®—æ³•ï¼Œä¿è¯ç»Ÿè®¡ç²¾åº¦å’Œå®æ—¶æ€§
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œé¿å…å†…å­˜æ³„æ¼

### Shardedè®¡æ•°å™¨
åˆ†ç‰‡è®¾è®¡çš„é«˜æ€§èƒ½è®¡æ•°å™¨ï¼Œé€‚ç”¨äºè¶…é«˜å¹¶å‘åœºæ™¯ï¼š
- åŸºäºCPUæ ¸å¿ƒæ•°çš„è‡ªåŠ¨åˆ†ç‰‡ï¼Œé»˜è®¤ä¸º`runtime.NumCPU() * 4`
- ç»†ç²’åº¦é”è®¾è®¡ï¼Œæ¯ä¸ªæ—¶é—´æ§½ç‹¬ç«‹é”ï¼Œæœ€å¤§åŒ–å¹¶è¡Œæ€§
- å“ˆå¸Œç®—æ³•ç¡®ä¿è¯·æ±‚å‡åŒ€åˆ†å¸ƒåˆ°å„åˆ†ç‰‡

### è‡ªé€‚åº”åˆ†ç‰‡ç®¡ç†
- å®æ—¶ç›‘æ§QPSå˜åŒ–ç‡ï¼Œå½“å˜åŒ–è¶…è¿‡Â±30%æ—¶è§¦å‘åˆ†ç‰‡è°ƒæ•´
- å¢é•¿æ—¶å¢åŠ 50%åˆ†ç‰‡æ•°ï¼Œä¸‹é™æ—¶å‡å°‘30%åˆ†ç‰‡æ•°
- åˆ†ç‰‡æ•°èŒƒå›´æ§åˆ¶åœ¨CPUæ ¸å¿ƒæ•°åˆ°CPUæ ¸å¿ƒæ•°*8ä¹‹é—´ï¼Œé¿å…èµ„æºæµªè´¹

## âš™ï¸ é…ç½®è¯´æ˜
```yaml
server:
  port: 8080
  read_timeout: 5s
  write_timeout: 10s

counter:
  type: "lockfree"     # è®¡æ•°å™¨ç±»å‹ï¼ˆlockfree/shardedï¼‰
  window_size: 1s      # ç»Ÿè®¡æ—¶é—´çª—å£
  slot_num: 10         # çª—å£åˆ†ç‰‡æ•°é‡
  precision: 100ms     # ç»Ÿè®¡ç²¾åº¦

logger:
  level: info
  format: json
  file_path: "/var/log/qps-counter/app.log"
  max_size: 100
  max_backups: 3
  max_age: 7
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡
| å¼•æ“ç±»å‹   | å¹¶å‘é‡ | å¹³å‡å»¶è¿Ÿ | P99å»¶è¿Ÿ | QPS     |
|------------|--------|---------|--------|--------|
| Lock-Free  | 10k    | 1.2ms   | 3.5ms  | 950k   |
| Sharded    | 50k    | 3.8ms   | 9.2ms  | 4.2M   |

é«˜è´Ÿè½½åœºæ™¯æµ‹è¯•ç»“æœï¼š
| å¼•æ“ç±»å‹   | å¹¶å‘é‡ | å¹³å‡å»¶è¿Ÿ | P99å»¶è¿Ÿ | QPS     |
|------------|--------|---------|--------|--------|
| Lock-Free  | 100k   | 1.2ms   | 3.5ms  | 1.23M  |
| Sharded    | 500k   | 3.8ms   | 9.2ms  | 4.75M  |

## ğŸ›¡ï¸ å¥åº·æ£€æŸ¥ä¸ç›‘æ§

### å¥åº·æ£€æŸ¥ç«¯ç‚¹
```http
GET /healthz
å“åº”:
{
  "status": "OK"
}
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…
```bash
# å…‹éš†ä»“åº“
$ git clone https://github.com/mant7s/qps-counter.git
$ cd qps-counter

# å¤åˆ¶é…ç½®æ–‡ä»¶
$ cp config/config.example.yaml config/config.yaml

# ç¼–è¯‘
$ make build

# è¿è¡Œ
$ ./bin/qps-counter
```

### Dockeréƒ¨ç½²
```bash
# ä½¿ç”¨Dockeréƒ¨ç½²
$ git clone https://github.com/mant7s/qps-counter.git
$ cd qps-counter
$ cp config/config.example.yaml config/config.yaml
$ cd deployments
$ docker-compose up -d --scale qps-counter=3

# éªŒè¯éƒ¨ç½²
$ curl http://localhost:8080/healthz
```

## ğŸ“š APIæ–‡æ¡£

### å¢åŠ è®¡æ•°
```http
POST /collect
è¯·æ±‚ä½“:
{
  "count": 1
}
å“åº”: 202 Accepted
```

### è·å–å½“å‰QPS
```http
GET /qps
å“åº”: 
{
  "qps": 12345
}
```

## ğŸ”§ å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„
```
â”œâ”€â”€ cmd/          # å…¥å£ç¨‹åº
â”œâ”€â”€ config/       # é…ç½®æ–‡ä»¶
â”œâ”€â”€ internal/     # å†…éƒ¨åŒ…
â”‚   â”œâ”€â”€ api/      # APIå¤„ç†å™¨
â”‚   â”œâ”€â”€ config/   # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ counter/  # è®¡æ•°å™¨å®ç°
â”‚   â””â”€â”€ logger/   # æ—¥å¿—ç»„ä»¶
â”œâ”€â”€ deployments/  # éƒ¨ç½²é…ç½®
â””â”€â”€ tests/        # æµ‹è¯•ä»£ç 
```

### è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
$ make test

# è¿è¡ŒåŸºå‡†æµ‹è¯•
$ make benchmark
```

## ğŸ¤ è´¡çŒ®æŒ‡å—
1. Forké¡¹ç›®å¹¶åˆ›å»ºåˆ†æ”¯
2. æ·»åŠ æµ‹è¯•ç”¨ä¾‹
3. æäº¤Pull Request
4. éµå¾ªGoä»£ç è§„èŒƒï¼ˆä½¿ç”¨gofmtï¼‰

## ğŸ“„ è®¸å¯è¯
MIT License

## ğŸ“ è”ç³»æ–¹å¼
- é¡¹ç›®ç»´æŠ¤è€…: [mant7s](https://github.com/mant7s)
- é—®é¢˜åé¦ˆ: [Issues](https://github.com/mant7s/qps-counter/issues)